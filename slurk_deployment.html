

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>7. Deploying the system &mdash; slurk 1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="8. Getting participants from Amazon Mechanical Turk" href="slurk_amt.html" />
    <link rel="prev" title="6. Writing your own bots" href="slurk_bots.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> slurk
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="slurk_about.html">1. Slurk: What’s this?</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_installation.html">2. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_quickstart.html">3. Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_multibots.html">4. Pairing up participants and running multiple rooms (and bots)</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_layouts.html">5. Layouts and Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_bots.html">6. Writing your own bots</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">7. Deploying the system</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#general-description-and-requirements">7.1. General description and requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="#serving-slurk-with-gunicorn">7.2. Serving Slurk with Gunicorn</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuring-nginx">7.3. Configuring Nginx</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="slurk_amt.html">8. Getting participants from Amazon Mechanical Turk</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">slurk</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>7. Deploying the system</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/slurk_deployment.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="deploying-the-system">
<span id="slurk-deployment"></span><h1>7. Deploying the system<a class="headerlink" href="#deploying-the-system" title="Permalink to this headline">¶</a></h1>
<div class="section" id="general-description-and-requirements">
<h2>7.1. General description and requirements<a class="headerlink" href="#general-description-and-requirements" title="Permalink to this headline">¶</a></h2>
<p>This section includes information on how to run Slurk on Nginx server (Ubuntu 18.04)
with SSL connection.</p>
<p>First, you have to be sure that Python3.6+ is installed on your machine. Please navigate to
<code class="docutils literal notranslate"><span class="pre">server</span></code> and install required packages via executing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>Also please make sure that your Ubuntu server is running on Nginx <a class="footnote-reference" href="#id6" id="id1">[1]</a> and <code class="docutils literal notranslate"><span class="pre">systemd</span></code> package is installed.
Do not forget to check if UFW (Uncomplicated Firewall) is installed on your machine <a class="footnote-reference" href="#id7" id="id2">[2]</a>.</p>
</div>
<div class="section" id="serving-slurk-with-gunicorn">
<h2>7.2. Serving Slurk with Gunicorn<a class="headerlink" href="#serving-slurk-with-gunicorn" title="Permalink to this headline">¶</a></h2>
<p>You can serve our Flask application on a permanent basis.
Such setup will allow you to have faster connections which are automatic since you are not required to manually start
the process with Python, but Nginx will configure everything for you. Most of the instructions are taken or adopted from
<a class="reference external" href="https://www.digitalocean.com/community/tutorials/how-to-serve-flask-applications-with-gunicorn-and-nginx-on-ubuntu-18-04">this tutorial</a>.</p>
<p>First, isolate your Flask application on your computer. For this you have to install <em>virtualenv</em> package.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">python3</span><span class="o">-</span><span class="n">venv</span>
</pre></div>
</div>
<p>Navigate to your project directory and create a new project environment there. Also activate the environment and
install required packages:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~/</span><span class="n">server</span>
<span class="n">python3</span><span class="o">.</span><span class="mi">6</span> <span class="o">-</span><span class="n">m</span> <span class="n">venv</span> <span class="n">serverenv</span>
<span class="n">source</span> <span class="n">serverenv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>Now, assuming that <em>gunicorn</em> and <em>flask</em> are already installed, we will create the WSGI entry point for our application.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nano</span> <span class="o">~/</span><span class="n">server</span><span class="o">/</span><span class="n">wsgi</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>The chat instance itself is created in <code class="docutils literal notranslate"><span class="pre">~/server/app/__init__.py</span></code>, and that is why we will use this instance in our <cite>wsgi.py</cite> file.
Import this instance into the file, save and close it once you are finished:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">app</span> <span class="k">import</span> <span class="n">create_app</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Next step would be to configure Gunicorn, but first we should check if the application is served correctly <a class="footnote-reference" href="#id8" id="id3">[3]</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~/</span><span class="n">server</span>
<span class="n">gunicorn</span> <span class="o">--</span><span class="n">bind</span> <span class="n">host</span><span class="p">:</span><span class="mi">5000</span> <span class="o">-</span><span class="n">k</span> <span class="n">geventwebsocket</span><span class="o">.</span><span class="n">gunicorn</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">GeventWebSocketWorker</span> <span class="n">wsgi</span><span class="p">:</span><span class="n">app</span>
</pre></div>
</div>
<p>Visit you server’s address with the port <code class="docutils literal notranslate"><span class="pre">:5000</span></code> and check if you see the login page.
If it functions properly, please press <code class="docutils literal notranslate"><span class="pre">CTRL-C</span></code> in your terminal window and deactivate your environment.</p>
<p>Now we have to create the systemd service unit file. It will allow Ubuntu to automatically start our application
once the machine boots.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">nano</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">chat</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
<p>Fill this service file with information about your application and adjust paths/variable names where required:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">Gunicorn</span> <span class="n">instance</span> <span class="n">to</span> <span class="n">serve</span> <span class="n">MeetUp</span>
<span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="o">.</span><span class="n">target</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">User</span><span class="o">=</span><span class="n">user</span>
<span class="n">Group</span><span class="o">=</span><span class="n">www</span><span class="o">-</span><span class="n">data</span>
<span class="n">WorkingDirectory</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">server</span>
<span class="n">Environment</span><span class="o">=</span><span class="s2">&quot;PATH=/home/user/server/serverenv/bin&quot;</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">serverenv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">gunicorn</span> <span class="o">--</span><span class="n">bind</span> <span class="n">unix</span><span class="p">:</span><span class="n">myproject</span><span class="o">.</span><span class="n">sock</span> <span class="o">-</span><span class="n">k</span> <span class="n">geventwebsocket</span><span class="o">.</span><span class="n">gunicorn</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">GeventWebSocketWorker</span> <span class="o">-</span><span class="n">m</span> <span class="mi">007</span> <span class="n">wsgi</span><span class="p">:</span><span class="n">app</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
<p>Save and close this file. Now we will start the Gunicorn service and enable it so that it is active once our machine is booted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">chat</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">chat</span>
</pre></div>
</div>
<p>To be sure that it is active, check its status:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">status</span> <span class="n">chat</span>
</pre></div>
</div>
<p>The output should be similar to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>chat.service - Gunicorn instance to serve meetup
Loaded: loaded (/etc/systemd/system/chat.service; enabled; vendor preset: enabled)
Active: active (running) since Fri 2018-08-17 11:25:12 CEST; 4h 20min ago
Main PID: 18101 (gunicorn)
Tasks: 2 (limit: 4915)
CGroup: /system.slice/chat.service
      ├─18101 /home/user/slurk/server/chatenv/bin/python3 /home/user/slurk/server/chatenv/bin/gunicorn --bind unix:chat.sock -k geventwebsocket.gunicorn.workers.GeventWebSocketWorker
      └─18103 /home/user/slurk/server/chatenv/bin/python3 /home/user/slurk/server/chatenv/bin/gunicorn --bind unix:chat.sock -k geventwebsocket.gunicorn.workers.GeventWebSocketWorker
</pre></div>
</div>
</div>
<div class="section" id="configuring-nginx">
<h2>7.3. Configuring Nginx<a class="headerlink" href="#configuring-nginx" title="Permalink to this headline">¶</a></h2>
<p>At this point our Gunicorn application server must be actively running, and now we have to enable Nginx to accept requests for our application.
First, we will create a new server block configuration file in Nginx’s <cite>sites-available</cite> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">nano</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">chat</span>
</pre></div>
</div>
<p>We will have to specify location of our socket file, that serves the application
and include certificates which were created earlier <a class="footnote-reference" href="#id9" id="id4">[4]</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">server</span> <span class="p">{</span>

    <span class="n">listen</span> <span class="mi">5000</span> <span class="n">ssl</span> <span class="n">default_server</span><span class="p">;</span>
    <span class="n">listen</span> <span class="p">[::]:</span><span class="mi">5000</span> <span class="n">ssl</span> <span class="n">default_server</span><span class="p">;</span>

    <span class="n">server_name</span> <span class="n">_</span><span class="p">;</span>
    <span class="n">root</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">slurk</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">app</span><span class="p">;</span>

    <span class="n">access_log</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">slurk</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">nginx_logs</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">access</span><span class="o">.</span><span class="n">log</span><span class="p">;</span>
    <span class="n">error_log</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">slurk</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">nginx_logs</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">error</span><span class="o">.</span><span class="n">log</span><span class="p">;</span>

    <span class="n">include</span> <span class="n">snippets</span><span class="o">/</span><span class="n">certs</span><span class="o">.</span><span class="n">conf</span><span class="p">;</span>
    <span class="n">include</span> <span class="n">snippets</span><span class="o">/</span><span class="n">ssl</span><span class="o">-</span><span class="n">params</span><span class="o">.</span><span class="n">conf</span><span class="p">;</span>

    <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
        <span class="n">include</span> <span class="n">proxy_params</span><span class="p">;</span>
        <span class="n">proxy_pass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">unix</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">slurk</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">chat</span><span class="o">.</span><span class="n">sock</span><span class="p">;</span>

        <span class="p">}</span>

    <span class="p">}</span>
</pre></div>
</div>
<p>Do not forget to link this file to the <code class="docutils literal notranslate"><span class="pre">sites-enabled</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">myproject</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">enabled</span>
</pre></div>
</div>
<p>Test it for syntax errors and restart Nginx:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">nginx</span> <span class="o">-</span><span class="n">t</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">nginx</span>
</pre></div>
</div>
<p>As the last step, adjust UFW setting once again, adding full access to the Nginx server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ufw</span> <span class="n">delete</span> <span class="n">allow</span> <span class="mi">5000</span>
<span class="n">sudo</span> <span class="n">ufw</span> <span class="n">allow</span> <span class="s1">&#39;Nginx Full&#39;</span>
</pre></div>
</div>
<p>When you navigate to your server’s domain name, you should be able to see the login interface <a class="footnote-reference" href="#id10" id="id5">[5]</a>.</p>
<p>Congratulations! You have managed to fully deploy Slurk!</p>
<hr class="docutils" />
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>There is a nice tutorial on <a class="reference external" href="https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-18-04">how to install Nginx on Ubuntu 18.04</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>A very detailed tutorial can be found here: <a class="reference external" href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04">Initial Server Setup with Ubuntu 18.04</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><p class="first">An important thing is that you specify type of the worker associated with the Gunicorn process. You should use websockets provided by <cite>gevent</cite> package:</p>
<p><code class="docutils literal notranslate"><span class="pre">-k</span> <span class="pre">geventwebsocket.gunicorn.workers.GeventWebSocketWorker</span></code></p>
<p class="last">More information can be found in <a class="reference external" href="http://flask.pocoo.org/docs/1.0/deploying/wsgi-standalone/#gunicorn">official Flask documentation</a>.</p>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td><p class="first">Different configurations require specification of static files’ location,
which include CSS files of your applications. In order to enable it, add additional
location block where you specify location of the static files:</p>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">location</span> <span class="o">/</span><span class="n">static</span><span class="o">/</span> <span class="p">{</span>
    <span class="n">alias</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">static</span><span class="o">/</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[5]</a></td><td>Regarding the port that you use: some ports are not accessible for the use (for example, <code class="docutils literal notranslate"><span class="pre">7000</span></code> is used for internal processes), so be careful when deciding which port to use.
If you choose incorrect one, the application will not be accessible from outside of your network, even if you adjust firewall settings.</td></tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="slurk_amt.html" class="btn btn-neutral float-right" title="8. Getting participants from Amazon Mechanical Turk" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="slurk_bots.html" class="btn btn-neutral float-left" title="6. Writing your own bots" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, DSG Bielefeld

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>