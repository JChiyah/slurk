<html lang="en">

<head>
    <title>Slurk</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='3rd_party/font-awesome-4.7.0/css/font-awesome.min.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/global.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}" />

    <script type="text/javascript" src="{{ url_for('static', filename='js/3rd_party/jquery-3.2.1.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/3rd_party/socket.io-2.0.3.min.js') }}"></script>
    <script type="text/javascript" charset="utf-8">
        const BORDERSIZE = 7;
        let socket;
        let is_typing = -1;
        let typing = {};
        let self_user = undefined;
        let self_room = undefined;
        let history_received = false;
        let users = {};
        let print_history = undefined;
        let update_typing = undefined;
        let keypress = undefined;
        let incoming_message = undefined;

        function getTime(timestamp) {
            if (typeof timestamp === "undefined")
                return new Date().getHours() + ':' + new Date().getMinutes();
            let currentDate = new Date((timestamp + new Date().getTimezoneOffset() * 60) * 1000);
            return currentDate.getHours() + ":" + (currentDate.getMinutes() < 10 ? "0" + currentDate.getMinutes() : "" + currentDate.getMinutes());
        }

        function append(text) {
            $('#chat-area').append(text);
            let content = $('#content');
            content.animate({ scrollTop: content.prop("scrollHeight") }, 0);
        }

        function display_message(sender, time, message, privateMessage) {
            if (self_user === undefined) {
                return;
            }

            let classes = "";
            if (self_user.id === sender.id) {
                classes += "self";
            } else {
                classes += "other";
            }

            if (privateMessage) {
                classes += " private";
            }
            let text = $(
                "<li class='" + classes + "'>" +
                "  <div class='message-box'>" +
                "    <div>" +
                "      <span class='user'></span>" +
                "      <time></time>" +
                "    </div>" +
                "    <span class='msg'></span>" +
                "  </div>" +
                "</li>");
            text.find(".user").text(self_user.id === sender.id ? "You" : sender.name);
            text.find(".msg").text(message);
            text.find("time").text(getTime(time));
            append(text);
        }

        function display_image(sender, time, url, width, height, privateMessage) {
            if (self_user === undefined) {
                return;
            }

            let classes = "";
            if (self_user.id === sender.id) {
                classes += "self";
            } else {
                classes += "other";
            }
            if (privateMessage) {
                classes += " private";
            }

            if (width !== null) {
                width = parseInt(width);
            } else {
                width = 200;
            }
            if (height !== null) {
                height = parseInt(height);
            } else {
                height = 200;
            }

            let text = $(
                "<li class='" + classes + "'>" +
                "  <div class='message-box'>" +
                "    <div class='user'>" +
                "      <time></time>" +
                "    </div>" +
                "    <img/>" +
                "  </div>" +
                "</li>");
            text.find(".user").text(self_user.id === sender.id ? "You" : sender.name);
            text.find("time").text(getTime(time));
            text.find("img").attr("src", url).attr("width", width).attr("height", height);
            append(text);
        }

        function display_info(time, message) {
            let text = $(
                "<li class='notification'>" +
                "  <p class='msg'></p>" +
                "  <time></time>" +
                "</li>");
            text.find(".msg").text(message);
            text.find("time").text(getTime(time));
            append(text);
        }

        function unknown_error(time) {
            let text = $(
                "<li class='notification'>" +
                "  <p class='msg'></p>" +
                "  <time></time>" +
                "</li>");
            text.find(".msg").html('An unknown error occurred.<br \>Please feel free to <a href="https://github.com/clp-research/slurk/issues/new">file the bug<\a>');
            text.find("time").text(getTime(time));
            append(text);
        }

        function submit_text(text, resolve, reject) {
            socket.emit('text', { room: self_room, msg: text }, (success, error) => {
                if (verify_query(success, error)) {
                    if (resolve !== undefined)
                        resolve();
                } else {
                    if (reject !== undefined) {
                        reject(error);
                    }
                }
            });
        }

        function submit_image(url, width, height, resolve, reject) {
            socket.emit('image', { room: self_room, url: url, width: width, height: height }, (success, error) => {
                if (verify_query(success, error)) {
                    if (resolve !== undefined)
                        resolve();
                } else {
                    if (reject !== undefined) {
                        reject(error);
                    }
                }
            });
        }

        function submit_command(parameter, resolve, reject) {
            socket.emit('command', { room: self_room, data: parameter }, (success, error) => {
                if (verify_query(success, error)) {
                    if (resolve !== undefined)
                        resolve();
                } else {
                    if (reject !== undefined) {
                        reject(error);
                    }
                }
            });
        }

        function updateUsers() {
            let current_users = "You";
            for (let idx in users) {
                current_users += ", " + users[idx];
            }
            $('#current-users').text(current_users);
        }

        function apply_user_permissions(permissions) {
            if (permissions.message.text || permissions.message.image || permissions.message.command) {
                $('#type-area').show();
            }
        }

        function apply_room_properties(room) {
            if (room.read_only) {
                $('#text').prop('readonly', true).prop('placeholder', 'This room is read-only');
            } else {
                $('#text').prop('readonly', false).prop('placeholder', 'Enter your message here!');
            }
        }

        function apply_layout(layout) {
            console.log(layout);
            if (layout.html !== "") {
                $("#sidebar").html(layout.html);
            }
            if (layout.css !== "") {
                $("#custom-styles").html(layout.css);
            }
            if (layout.script !== "") {
                window.eval(layout.script);
            }
            if (layout.title !== "") {
                document.title = layout.title;
            } else {
                document.title = 'Slurk';
            }
            $("#title").text(document.title);
            if (layout.subtitle !== "") {
                $("#subtitle").text(layout.subtitle);
            }
        }

        function verify_query(success, message) {
            if (!success) {
                if (message === "invalid session id") {
                    // Reload page if user is not logged in
                    window.location.reload();
                } else {
                    console.error(message)
                }
                return false;
            }
            return true;
        }

        $(document).ready(function () {
            $('#type-area').hide();

            const sidebar = document.getElementById("sidebar");
            const content = document.getElementById("content");

            let splitter_pos;
            function resize(e) {
                const dx = splitter_pos - e.x;
                splitter_pos = e.x;
                sidebar.style.width = (parseInt(getComputedStyle(sidebar, '').width + BORDERSIZE) + dx) + "px";
                content.style.width = (parseInt(getComputedStyle(content, '').width + BORDERSIZE) - dx) + "px";
            }

            sidebar.addEventListener("mousedown", function (e) {
                // console.log("mousedown", e.offsetX);
                if (e.offsetX < BORDERSIZE) {
                    splitter_pos = e.x;
                    document.addEventListener("mousemove", resize, false);
                }
            }, false);

            document.addEventListener("mouseup", function () {
                document.removeEventListener("mousemove", resize, false);
            }, false);

            $('#latency').hide();
            $('#user-list').hide();
            socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
            let startTime;
            let ping_pong_times = [];
            window.setInterval(function () {
                startTime = (new Date).getTime();
                socket.emit("my_ping", { "typing": is_typing });
                if (is_typing !== -1) {
                    is_typing += 1;
                }
            }, 1000);

            socket.on('connect', (data) => {
                socket.emit("get_user", null, (success, user) => {
                    if (verify_query(success, user)) {
                        console.log("user", user);
                        self_user = user;
                    }
                });
                socket.emit('get_rooms_by_user', null, (success, rooms) => {
                    if (verify_query(success, rooms)) {
                        console.log("rooms", rooms);
                        let room = rooms[0];
                        if (room) {
                            self_room = room.name;
                            apply_room_properties(room);
                        }
                    }
                });
                socket.emit("get_layouts_by_user", null, (success, layouts) => {
                    if (verify_query(success, layouts)) {
                        console.log("layouts", layouts);
                        let room = Object.keys(layouts)[0];
                        if (room && layouts[room]) {
                            apply_layout(layouts[room]);
                        }
                    }
                });
                socket.emit("get_permissions_by_user", null, (success, permissions) => {
                    if (verify_query(success, permissions)) {
                        console.log("permissions", permissions);
                        apply_user_permissions(permissions);
                    }
                });
            });

            {#socket.on('joined_room', function (payload) {#}
            {#    // console.log("permissions: ", data.permissions);#}
            {#    self_user = payload.self;#}
            {#    self_user.name = "You";#}
            {#    self_room = payload.room.id;#}
            {##}
            {#    // console.log("joined room:", data);#}
            {#    if (payload.layout.html !== "") {#}
            {#        $("#sidebar").html(payload.layout.html);#}
            {#    }#}
            {#    if (payload.layout.css !== "") {#}
            {#        $("#custom-styles").html(payload.layout.css);#}
            {#    }#}
            {#    if (payload.layout.eval !== "") {#}
            {#        window.eval(payload.layout.eval);#}
            {#    }#}
            {#    if (payload.layout.script !== "") {#}
            {#        $("#custom-scripts").html(payload.layout.script);#}
            {#    }#}
            {##}
            {#    if (payload.layout.title !== "") {#}
            {#        document.title = payload.layout.title;#}
            {#    } else {#}
            {#        document.title = 'Slurk';#}
            {#    }#}
            {#    $("#title").text(document.title);#}
            {#    if (payload.layout.subtitle !== "") {#}
            {#        $("#subtitle").text(payload.layout.subtitle);#}
            {#    } else {#}
            {#        $("#subtitle").text(payload.room.label);#}
            {#    }#}
            {##}
            {#    users = payload.room.users;#}
            {#    updateUsers();#}
            {#    updatePermissions(data.permissions);#}
            {#    if (!history_received && print_history !== undefined) {#}
            {#        print_history(data["history"]);#}
            {#        history_received = true;#}
            {#    }#}
            // {#});#}

            socket.on("my_pong", function () {
                let latency = (new Date).getTime() - startTime;
                ping_pong_times.push(latency);
                ping_pong_times = ping_pong_times.slice(-5);
                let sum = 0;
                for (let i = 0; i < ping_pong_times.length; ++i)
                    sum += ping_pong_times[i];
                let ping = $("#ping");
                ping.text(Math.round(10 * sum / ping_pong_times.length) / 10);
            });

            socket.on("message", function (data) {
                console.log("message", data);
                if (incoming_message !== undefined && data.sender.id !== self_user.id) {
                    incoming_message(data)
                }
            });

            socket.on('status', function (data) {
                if (typeof self_user === "undefined")
                    return;
                switch (data.type) {
                    case "join":
                        let user = data.user;
                        if (user.id !== self_user) {
                            users[user.id] = user.name;
                            updateUsers();
                        }
                        break;
                    case "leave":
                        delete users[data.user.id];
                        updateUsers();
                        break;
                    case "new_image":
                        display_info(data.timestamp, 'You have received a new image!');
                        break;
                    case "undefined_command":
                        display_info(data.timestamp, 'Command could not be recognized!');
                        break;
                }
            });

            socket.on('start_typing', function (data) {
                typing[data.sender.id] = data.sender.name;
                if (update_typing !== undefined) {
                    update_typing(typing);
                }
            });

            socket.on('stop_typing', function (data) {
                delete typing[data.sender.id];
                if (update_typing !== undefined) {
                    update_typing(typing);
                }
            });

            socket.on('clear_chat_area', function () {
                $('#chat-area').empty()
            });

            socket.on('new_permissions', function (data) {
                updatePermissions(data.permissions)
            });

            socket.on('new_image', function (data) {
                // console.log("New image:", data);
                $('#' + data.id).attr('src', data.url).show();
            });

            socket.on('attribute_update', function (data) {
                // console.log("Attribute updated:", data);
                if (data.id)
                    $('#' + data.id).attr(data.attribute, data.value).show();
                if (data.class)
                    $('.' + data.class).attr(data.attribute, data.value).show();
                if (data.element)
                    $(data.element).attr(data.attribute, data.value).show();
            });

            socket.on('class_add', function (data) {
                // console.log("Class added:", data);
                $('#' + data.id).addClass(data.class);
            });

            socket.on('class_remove', function (data) {
                // console.log("Class removed:", data);
                $('#' + data.id).removeClass(data.class);
            });

            socket.on('text_update', function (data) {
                // console.log("Text updated:", data);
                $('#' + data.id).text(data.text).show();
            });

            $('#text').keypress(function(e) {
                if (keypress === undefined || $('#text').is('[readonly]')) {
                    return;
                }
                is_typing = 0;
                let code = e.keyCode || e.which;
                // 13: RETURN key
                if (code === 13) {
                    let text = $(e.target).val();
                    $(e.target).val('');
                    if (text === '') {
                        return
                    }
                    is_typing = -1;
                    let date = new Date();
                    let time = date.getTime() - date.getTimezoneOffset() * 60000;
                    keypress(self_room, self_user, time / 1000, text);
                }
            });
        });
    </script>
    <script type="text/javascript" charset="utf-8" id="custom-scripts"></script>
    <style id="custom-styles"></style>
</head>

<body>
    <header>
        <nav>
            <h1 id="title"></h1>
            <h2 id="subtitle"></h2>
            <span id="latency" class="latency">Latency: <span id="ping">999</span> ms</span>
            <span id="user-list" class="users">Users: <span id="current-users"></span></span>
        </nav>
    </header>
    <div id="sidebar"></div>
    <div id="content">
        <div id="chat-area"></div>
    </div>
    <div id="type-area">
        <input id="text" size="80" placeholder="Enter your message here!" readonly="readonly"><br><br>
    </div>
</body>

</html>
